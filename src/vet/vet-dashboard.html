<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vet Dashboard - VetAI Triage</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="vet.css">
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    .call-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid var(--vet-primary);
    }
    .call-card.urgent {
      border-left-color: var(--vet-danger);
    }
    .call-card.medium {
      border-left-color: var(--vet-warning);
    }
    .call-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .call-pet-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .call-pet-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--vet-bg-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .call-time {
      font-size: 0.85rem;
      color: var(--vet-text-muted);
    }
    .call-symptoms {
      font-size: 0.9rem;
      color: var(--vet-text-muted);
      margin-bottom: 15px;
    }
    .no-calls {
      text-align: center;
      padding: 60px 20px;
      color: var(--vet-text-muted);
    }
    .no-calls i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    .vet-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .vet-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--vet-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--vet-primary);
    }
    .stat-label {
      font-size: 0.85rem;
      color: var(--vet-text-muted);
    }
  </style>
</head>
<body>
  <div class="vet-container">
    <!-- Header -->
    <header class="vet-header">
      <div class="vet-logo">
        <i class="fas fa-paw"></i>
        <span>VetAI Triage</span>
      </div>
      <p class="vet-subtitle">Veterinarian Dashboard</p>
    </header>

    <!-- Main Content -->
    <main class="vet-card" style="padding: 25px;">
      <!-- Dashboard Header -->
      <div class="dashboard-header">
        <div class="vet-info">
          <div class="vet-avatar">
            <i class="fas fa-user-md"></i>
          </div>
          <div>
            <strong id="vet-name">Dr. Veterinarian</strong>
            <div style="font-size: 0.85rem; color: var(--vet-text-muted);">On Duty</div>
          </div>
        </div>
        <button class="vet-btn vet-btn-secondary" id="logout-btn" style="padding: 10px 20px;">
          <i class="fas fa-sign-out-alt"></i>
          Logout
        </button>
      </div>

      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-number" id="pending-count">0</div>
          <div class="stat-label">Pending Calls</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="today-count">0</div>
          <div class="stat-label">Calls Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="urgent-count">0</div>
          <div class="stat-label">Urgent</div>
        </div>
      </div>

      <!-- Pending Calls Section -->
      <h3 style="margin-bottom: 15px; color: var(--vet-text-dark);">
        <i class="fas fa-phone-volume" style="color: var(--vet-primary); margin-right: 10px;"></i>
        Incoming Call Requests
      </h3>

      <div id="calls-container">
        <div class="no-calls">
          <i class="fas fa-phone-slash"></i>
          <p>No pending calls at the moment.</p>
          <p style="font-size: 0.9rem;">New call requests will appear here automatically.</p>
        </div>
      </div>

      <!-- Refresh Info -->
      <div style="text-align: center; margin-top: 20px; color: var(--vet-text-muted); font-size: 0.85rem;">
        <i class="fas fa-sync-alt"></i>
        Auto-refreshing every 3 seconds
      </div>

      <!-- Ready to Call -->
      <h3 style="margin: 25px 0 12px; color: var(--vet-text-dark);" id="ready-header">
        <i class="fas fa-video" style="color: var(--vet-primary); margin-right: 10px;"></i>
        Ready to Call
      </h3>
      <div id="ready-calls">
        <div class="no-calls">
          <p>No triaged calls yet.</p>
        </div>
      </div>
    </main>

    <!-- Footer Note -->
    <footer class="vet-footer-note">
      <i class="fas fa-headset"></i>
      Click "Accept Call" to connect with a pet owner via voice call.
    </footer>
  </div>

  <!-- Toast Notification -->
  <div class="vet-toast" id="toast"></div>

  <script>
    /**
     * ===========================================
     * HARDCODED CALL CHANNEL - EASY TO REPLACE
     * ===========================================
     * For simplicity, we use a fixed channel name.
     * In production, use dynamic channels from server.
     */
    
    // ===== HARDCODED CHANNEL FOR DEMO (Replace with server API later) =====
    const FIXED_CALL_CHANNEL = "vet-human-call";
    const VET_UID = 20001;  // Vet's user ID in the call
    const USER_UID = 20000; // Patient's user ID in the call
    // ======================================================================

    // State
    let vetSession = null;
    let pollInterval = null;

    // DOM Elements
    const vetName = document.getElementById('vet-name');
    const logoutBtn = document.getElementById('logout-btn');
    const callsContainer = document.getElementById('calls-container');
    const pendingCount = document.getElementById('pending-count');
    const todayCount = document.getElementById('today-count');
    const urgentCount = document.getElementById('urgent-count');
    const toast = document.getElementById('toast');

    // Show toast
    function showToast(message, duration = 3000) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // Check authentication (fallback demo session if missing)
    function checkAuth() {
      const session = sessionStorage.getItem('vetai_vet_session');
      if (!session) {
        vetSession = { name: 'Dr. Demo Vet', id: 'demo' };
        sessionStorage.setItem('vetai_vet_session', JSON.stringify(vetSession));
      } else {
        vetSession = JSON.parse(session);
      }
      vetName.textContent = vetSession.name || 'Veterinarian';
      return true;
    }

    // Logout
    function logout() {
      sessionStorage.removeItem('vetai_vet_session');
      window.location.href = 'vet-login.html';
    }

    // Format time ago
    function timeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - new Date(timestamp).getTime()) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
      return `${Math.floor(seconds / 3600)} hr ago`;
    }

    function fetchPendingCalls() {
      const bookings = (() => {
        try { return JSON.parse(localStorage.getItem('vetai_bookings')) || []; } catch (e) { return []; }
      })();
      return bookings
        .filter(b => b.status === 'pending')
        .map(b => ({
          id: b.id,
          channelName: b.id,
          petName: b.petInfo?.name || 'Pet',
          petType: b.petInfo?.typeName || b.petInfo?.type || 'Unknown',
          petAge: b.petInfo?.age || 'Unknown age',
          petEmoji: getPetEmoji(b.petInfo?.type || ''),
          urgency: 'medium',
          symptoms: b.notes || 'Not specified',
          timestamp: b.createdAt || new Date().toISOString(),
          waitTime: b.time,
          vetName: b.vetName,
          triageSummary: b.triageSummary || []
        }));
    }

    // Get pet emoji
    function getPetEmoji(petType) {
      const emojis = {
        dog: 'üêï', cat: 'üê±', bird: 'üê¶', rabbit: 'üê∞',
        hamster: 'üêπ', fish: 'üêü', reptile: 'ü¶é', other: 'üêæ'
      };
      return emojis[petType] || 'üêæ';
    }

    // Mock calls for demo (when server API isn't set up)
    function updateBookingStatus(id, status) {
      const bookings = (() => {
        try { return JSON.parse(localStorage.getItem('vetai_bookings')) || []; } catch (e) { return []; }
      })();
      const idx = bookings.findIndex(b => b.id === id);
      if (idx >= 0) {
        bookings[idx].status = status;
        localStorage.setItem('vetai_bookings', JSON.stringify(bookings));
      }
    }

    function renderCalls(calls) {
      // Update stats
      pendingCount.textContent = calls.length;
      urgentCount.textContent = calls.filter(c => c.urgency === 'high').length;
      
      if (calls.length === 0) {
        callsContainer.innerHTML = `
          <div class="no-calls">
            <i class="fas fa-phone-slash"></i>
            <p>No pending calls at the moment.</p>
            <p style="font-size: 0.9rem;">New call requests will appear here automatically.</p>
          </div>
        `;
        return;
      }

      callsContainer.innerHTML = calls.map(call => `
        <div class="call-card ${call.urgency || 'medium'}">
          <div class="call-header">
            <div class="call-pet-info">
              <div class="call-pet-avatar">${call.petEmoji || 'üêæ'}</div>
              <div>
                <strong>${call.petName || 'Pet'}</strong>
                <div style="font-size: 0.85rem; color: var(--vet-text-muted);">
                  ${call.petType || 'Unknown'} ‚Ä¢ ${call.petAge || 'Age unknown'}
                </div>
              </div>
            </div>
            <div class="call-time">
              <i class="fas fa-clock"></i> ${timeAgo(call.timestamp)}
            </div>
          </div>
          <div class="call-symptoms">
            <strong>Notes:</strong> ${call.symptoms || 'No notes recorded'}
          </div>
          ${call.triageSummary?.length ? `
            <div class="call-symptoms" style="margin-top: 8px;">
              <strong>Triage summary:</strong>
              <ul style="margin: 6px 0 0 18px; padding: 0;">
                ${call.triageSummary.map(t => `<li>${t}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          <div class="vet-urgency vet-urgency-${call.urgency || 'medium'}" style="margin-bottom: 15px;">
            <i class="fas fa-exclamation-circle"></i>
            ${call.urgency === 'high' ? 'High Priority' : call.urgency === 'low' ? 'Low Priority' : 'Medium Priority'}
          </div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="vet-btn vet-btn-primary" onclick="acceptCall('${call.channelName || FIXED_CALL_CHANNEL}', '${call.id || '1'}')">
              <i class="fas fa-phone"></i>
              Accept
            </button>
            <button class="vet-btn vet-btn-secondary" onclick="declineCall('${call.id || '1'}')">
              <i class="fas fa-times"></i>
              Decline
            </button>
          </div>
        </div>
      `).join('');
    }

    function fetchReadyCalls() {
      const bookings = (() => {
        try { return JSON.parse(localStorage.getItem('vetai_bookings')) || []; } catch (e) { return []; }
      })();
      return bookings
        .filter(b => ['triaged', 'accepted', 'calling'].includes(b.status))
        .map(b => ({
          id: b.id,
          channelName: b.id,
          petName: b.petInfo?.name || 'Pet',
          petType: b.petInfo?.typeName || b.petInfo?.type || 'Unknown',
          petAge: b.petInfo?.age || 'Unknown age',
          petEmoji: getPetEmoji(b.petInfo?.type || ''),
          triageSummary: b.triageSummary || [],
          timestamp: b.createdAt || new Date().toISOString(),
          time: b.time,
          notes: b.notes,
          vetName: b.vetName
        }));
    }

    function renderReady(calls) {
      const container = document.getElementById('ready-calls');

      if (!container) return;
      if (!calls.length) {
        container.innerHTML = `<div class="no-calls"><p>No triaged calls yet.</p></div>`;
        return;
      }

      container.innerHTML = calls.map(call => `
        <div class="call-card" style="border-left-color: var(--vet-primary);">
          <div class="call-header">
            <div class="call-pet-info">
              <div class="call-pet-avatar">${call.petEmoji || 'üêæ'}</div>
              <div>
                <strong>${call.petName || 'Pet'}</strong>
                <div style="font-size: 0.85rem; color: var(--vet-text-muted);">
                  ${call.petType || 'Unknown'} ‚Ä¢ ${call.petAge || 'Age unknown'}
                </div>
              </div>
            </div>
            <div class="call-time">
              <i class="fas fa-clock"></i> ${call.time || 'Scheduled'}
            </div>
          </div>
          ${call.triageSummary?.length ? `
            <div class="call-symptoms">
              <strong>Triage summary:</strong>
              <ul style="margin: 6px 0 0 18px; padding: 0;">
                ${call.triageSummary.map(t => `<li>${t}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="vet-btn vet-btn-primary" onclick="startCall('${call.channelName || call.id}')">
              <i class="fas fa-phone"></i>
              Call Pet Owner
            </button>
          </div>
        </div>
      `).join('');
    }

    // Accept a call (booking)
    function acceptCall(channelName, callId) {
      updateBookingStatus(callId, 'accepted');
      // Do not jump to call; wait for triage to complete and appear in Ready to Call
      pollCalls();
    }

    function declineCall(callId) {
      updateBookingStatus(callId, 'declined');
      pollCalls();
    }

    function startCall(channelName) {
      updateBookingStatus(channelName, 'calling');
      sessionStorage.setItem('vetai_active_booking', channelName || FIXED_CALL_CHANNEL);
      localStorage.setItem('vetai_call_channel', channelName || FIXED_CALL_CHANNEL);
      sessionStorage.setItem('vetai_call_channel', channelName || FIXED_CALL_CHANNEL);
      sessionStorage.setItem('vetai_active_call', JSON.stringify({
        channelName: channelName || FIXED_CALL_CHANNEL,
        callId: channelName || FIXED_CALL_CHANNEL,
        vetUid: VET_UID,
        userUid: USER_UID
      }));
      window.location.href = 'vet-call.html';
    }

    // Poll for new calls
    async function pollCalls() {
      const calls = fetchPendingCalls();
      renderCalls(calls);
      const ready = fetchReadyCalls();
      renderReady(ready);
    }

    // Initialize
    function init() {
      if (!checkAuth()) return;
      
      // Initial load
      pollCalls();
      
      // Start polling
      pollInterval = setInterval(pollCalls, 3000);
      
      // Update today count (mock)
      todayCount.textContent = Math.floor(Math.random() * 10) + 5;
    }

    // Event listeners
    logoutBtn.addEventListener('click', logout);

    // Cleanup on leave
    window.addEventListener('beforeunload', () => {
      if (pollInterval) clearInterval(pollInterval);
    });

    // Start
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
